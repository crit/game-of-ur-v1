const basic = [
  '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--',
  '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--',
  'ag', 'bg', 'bg', 'bg', 'bg', 'bg', 'bg', 'bg', 'cg', '--', '--', '--', '--', '--', '--', '--',
  'ah', 'bh', 'bh', 'bh', 'bh', 'bh', 'bh', 'bh', 'ch', '--', '--', '--', '--', '--', '--', '--',
  'ai', 'bi', 'bi', 'bi', 'bi', 'bi', 'ce', 'bh', 'ch', '--', '--', 'ag', 'bg', 'cg', '--', '--',
  'ag', 'bg', 'bg', 'bg', 'bg', 'bg', 'cf', 'bh', 'ch', '--', '--', 'ah', 'bh', 'bf', 'bg', 'cg',
  'ah', 'bh', 'bh', 'bh', 'bh', 'bh', 'bh', 'bh', 'ch', '--', '--', 'ah', 'bh', 'bh', 'bh', 'ch',
  'ah', 'bh', 'bh', 'bh', 'bh', 'bh', 'bh', 'bh', 'bf', 'bg', 'bg', 'cf', 'bh', 'bh', 'bh', 'ch',
  'ah', 'bh', 'bh', 'bh', 'bh', 'bh', 'bh', 'bh', 'bh', 'bh', 'bh', 'bh', 'bh', 'bh', 'bh', 'ch',
  'ah', 'bh', 'bh', 'bh', 'bh', 'bh', 'bh', 'bh', 'bh', 'bh', 'bh', 'bh', 'bh', 'bh', 'bh', 'ch',
  'ah', 'bh', 'bh', 'bh', 'bh', 'bh', 'bh', 'bh', 'be', 'bi', 'bi', 'ce', 'bh', 'bh', 'bh', 'ch',
  'ah', 'bh', 'bh', 'bh', 'bh', 'bh', 'bh', 'bh', 'ch', '--', '--', 'ah', 'bh', 'bh', 'bh', 'ch',
  'ai', 'bi', 'bi', 'bi', 'bi', 'bi', 'ce', 'bh', 'ch', '--', '--', 'ah', 'bh', 'be', 'bi', 'ci',
  'ag', 'bg', 'bg', 'bg', 'bg', 'bg', 'cf', 'bh', 'ch', '--', '--', 'ai', 'bi', 'ci', '--', '--',
  'ah', 'bh', 'bh', 'bh', 'bh', 'bh', 'bh', 'bh', 'ch', '--', '--', '--', '--', '--', '--', '--',
  'ai', 'bi', 'bi', 'bi', 'bi', 'bi', 'bi', 'bi', 'ci', '--', '--', '--', '--', '--', '--', '--',
]

const fence = [
  '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--',
  '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--',
  '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--',
  '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--',
  '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--',
  '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--',
  '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--',
  '--', '--', 'Al', 'Bl', 'Bl', 'Bl', 'Bl', 'Bl', 'Cl', '--', '--', 'Al', 'Bl', 'Cl', '--', '--',
  '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--',
  '--', '--', 'Al', 'Bl', 'Bl', 'Bl', 'Bl', 'Bl', 'Cl', '--', '--', 'Al', 'Bl', 'Cl', '--', '--',
  '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--',
  '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--',
  '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--',
  '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--',
  '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--',
  '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--',
]

const boats = [
  '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--',
  '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--',
  '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', 'lC', 'mC', 'nC', 'oC', '--',
  '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', 'lD', 'mD', 'nD', 'oD', '--',
  '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--',
  '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--',
  '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--',
  '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--',
  '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--',
  '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--',
  '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--',
  '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--',
  '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--',
  '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--',
  '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', 'lC', 'mC', 'nC', 'oC', '--',
  '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', '--', 'lD', 'mD', 'nD', 'oD', '--',
]

const board = [
  '--', '--', '--', '--', '--', '--', '--', '--',
  '--', '--', '--', '--', '--', '--', '--', '--',
  '--', '--', '--', '--', '--', '--', '--', '--',
  'ab', 'aa', 'aa', 'aa', '--', '--', 'ab', 'aa',
  'aa', 'aa', 'aa', 'ac', 'aa', 'aa', 'aa', 'aa',
  'ab', 'aa', 'aa', 'aa', '--', '--', 'ab', 'aa',
  '--', '--', '--', '--', '--', '--', '--', '--',
  '--', '--', '--', '--', '--', '--', '--', '--',
]

class Level {
  static tile(x = 0, y = 0, frame) {
    const entity = new Entity()

    entity.set(Components.position(x, y))
    entity.set(Components.size(32,32))
    entity.set(Components.type('tile'))
    entity.set(Components.active())

    entity.set(Components.renderer((context) => {
      const pos = entity.com('position')
      const size = entity.com('size')
      const image = assets.get(frame.src)

      context.drawImage(image, frame.x, frame.y, size.w, size.h, pos.x, pos.y, size.w, size.h)
    }))

    return entity
  }

  static parse(data, offset = {x: 0, y: 0}) {
    const entities = []

    const get = (col, row) => {
      return data.tiles[row * data.cols + col]
    }

    for (let col = 0; col < data.cols; col++) {
      for (let row = 0; row < data.rows; row++) {
        const letters = get(col, row)

        if (letters === '--') continue

        const pos = decode(letters)

        entities.push(Level.tile(col * data.size + offset.x, row * data.size + offset.y, {
          src: data.src, x: pos.x, y: pos.y
        }))
      }
    }

    return entities
  }

  static basic() {
    const entities = Level.parse({
      src: 'assets/frozenlake.png',
      cols: 16,
      rows: 16,
      size: 32,
      tiles: basic
    })

    // board outline
    const boardData = []

    const get = (col, row) => {
      return board[row * 8 + col]
    }

    for (let col = 0; col < 8; col++) {
      for (let row = 0; row < 8; row++) {
        const letters = get(col, row)
        if (letters === 'aa') boardData.push({x: col * 64, y: row * 64, type: 'simple'})
        if (letters === 'ab') boardData.push({x: col * 64, y: row * 64, type: 'repeat'})
        if (letters === 'ac') boardData.push({x: col * 64, y: row * 64, type: 'protect'})
      }
    }

    boardData.forEach(data => {
      const entity = new Entity()
      entity.set(Components.type(data.type))
      entity.set(Components.active())
      entity.set(Components.position(data.x, data.y))
      entity.set(Components.size(64, 64))
      entity.set(Components.renderer(context => {
        const image = assets.get('assets/atlas.png')

        if (data.type === 'simple') {
          context.drawImage(image, 32, 192, 32, 32, data.x + 24, data.y + 24, 16, 16)
        }

        if (data.type === 'repeat') {
          context.drawImage(image, 14 * 32, 11 * 32, 32, 32, data.x + 16, data.y + 10, 32, 32)
        }

        if (data.type === 'protect') {
          context.drawImage(image, 6 * 32, 9 * 32, 32, 32, data.x + 16, data.y + 10, 32, 32)
        }
      }))

      entities.push(entity)
    })

    // boats
    entities.push(...Level.parse({
      src: 'assets/atlas2.png',
      cols: 16,
      rows: 16,
      size: 32,
      tiles: boats
    }))

    // orc pieces
    for (let i = 0; i < 7; i++) {
      const entity = new Entity()
      entity.set(Components.active())

      entity.set(Components.renderer(context => {
        const image = assets.get('assets/orc.png')
        const pos = {x: 20 * i, y: 32 * 2}
        const size = 64
        const frame = {x: 0, y: 11 * 64}
        context.drawImage(image, frame.x, frame.y, size, size, pos.x, pos.y, size, size)
      }))

      entities.push(entity)
    }

    // skeleton pieces
    for (let i = 0; i < 7; i++) {
      const entity = new Entity()
      entity.set(Components.active())

      entity.set(Components.renderer(context => {
        const image = assets.get('assets/skeleton.png')
        const pos = {x: 20 * i, y: 32 * 13}
        const size = 64
        const frame = {x: 0, y: 11 * 64}
        context.drawImage(image, frame.x, frame.y, size, size, pos.x, pos.y, size, size)
      }))

      entities.push(entity)
    }

    // fence
    entities.push(...Level.parse({
      src: 'assets/atlas.png',
      cols: 16,
      rows: 16,
      size: 32,
      tiles: fence
    }, {x: 0, y: 10}))

    return entities
  }
}
